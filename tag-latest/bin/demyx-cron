#!/bin/bash
# Demyx
# https://demyx.sh
set -eEuo pipefail
#
#	Main.
#
demyx_cron() {
	# Support for old variable
    [[ -n "${WORDPRESS_DOMAIN:-}" ]] && export DEMYX_DOMAIN="$WORDPRESS_DOMAIN"
	local DEMYX_CRON="${1:-}"

	case "$DEMYX_CRON" in
		acl)
			demyx_cron_acl
		;;
		wp)
			demyx_cron_wp
		;;
	esac
}
#
#	Access Control.
#
demyx_cron_acl() {
	chown -R demyx:demyx "${DEMYX}" "${DEMYX_CONFIG}" "${DEMYX_LOG}" &
}
#
#	Events.
#
demyx_cron_wp() {
	local DEMYX_CRON_WP_PATH="$DEMYX"
	local DEMYX_CRON_WP_RANDOM=
	DEMYX_CRON_WP_RANDOM="$(shuf -i 1-30 -n 1)"
	[[ "$DEMYX_BEDROCK" = true ]] && DEMYX_CRON_WP_PATH="$DEMYX"/web/wp

	# Sleep between 1 to 30 seconds before executing cron
	#
	# Reduces server CPU when running over a dozen WP apps
	# so they don't execute cron at the same time
	#
	sleep "$DEMYX_CRON_WP_RANDOM"

	{
		echo "[$(date +%F-%T)] ======================================="
		php -d memory_limit="${DEMYX_MEMORY}" "${DEMYX_CRON_WP_PATH}/wp-cron.php"
	} | tee -a "${DEMYX_LOG}/${DEMYX_DOMAIN}.cron.log"
}
#
#	Init.
#
demyx_cron "$@"
